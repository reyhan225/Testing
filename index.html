<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stok Gudang Divisi PP</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-gray-800 p-4 shadow-md text-center">
    <h1 class="text-2xl font-bold">ðŸ“¦ Stok Gudang Divisi PP</h1>
  </header>

  <main class="flex-1 p-4 grid grid-cols-1 md:grid-cols-2 gap-6">

    <!-- Form Kelola Stok -->
    <section class="bg-gray-800 p-4 rounded-xl shadow-md">
      <h2 class="text-xl font-semibold mb-4">âž• Kelola Produk</h2>
      <form id="productForm" class="space-y-3">
        <input type="text" id="nama" placeholder="Nama Produk" required
               class="w-full p-2 rounded bg-gray-700 text-white">

        <!-- ðŸ”¹ Kategori bebas diisi user -->
        <input type="text" id="kategori" placeholder="Kategori (contoh: ATK, Elektronik, dll)" required
               class="w-full p-2 rounded bg-gray-700 text-white">

        <input type="number" id="jumlah" placeholder="Jumlah" required
               class="w-full p-2 rounded bg-gray-700 text-white">

        <!-- Input nama orang -->
        <input type="text" id="penginput" placeholder="Nama Penginput" required
               class="w-full p-2 rounded bg-gray-700 text-white">

        <button type="submit" 
          class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700 w-full">
          Tambah Produk
        </button>
      </form>
    </section>

    <!-- Daftar Produk -->
    <section class="bg-gray-800 p-4 rounded-xl shadow-md flex flex-col">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold">ðŸ“‹ Daftar Produk</h2>
        <input type="text" id="searchProduk" placeholder="Cari produk..."
               class="p-2 rounded bg-gray-700 text-white w-1/2">
      </div>

      <!-- Filter kategori (otomatis dari input user, opsional bisa dikosongkan dulu) -->
      <input type="text" id="filterKategori" placeholder="Filter kategori (opsional)" 
             class="mb-3 p-2 rounded bg-gray-700 text-white">

      <div id="productList" class="overflow-y-auto max-h-80 space-y-2"></div>
    </section>

    <!-- Riwayat -->
    <section class="bg-gray-800 p-4 rounded-xl shadow-md md:col-span-2 flex flex-col">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold">ðŸ“œ Riwayat Perubahan</h2>
        <select id="filterRiwayat" class="p-2 rounded bg-gray-700 text-white">
          <option value="all">Semua</option>
          <option value="7days">7 Hari Terakhir</option>
          <option value="30days">30 Hari Terakhir</option>
          <option value="custom">Pilih Tanggal</option>
        </select>
        <input type="date" id="tanggalFilter" class="p-2 rounded bg-gray-700 text-white hidden">
      </div>
      <div id="historyList" class="overflow-y-auto max-h-80 space-y-2"></div>
    </section>
  </main>

  <!-- âœ… Firebase Configuration -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getFirestore, collection, addDoc, setDoc, getDoc, doc, updateDoc, 
      increment, onSnapshot, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // âœ… Config Punya Kamu
    const firebaseConfig = {
      apiKey: "AIzaSyCk_9zFTS5CRgmIcuswG_gvpLVWx2PcF58",
      authDomain: "stok-gudang-divisi-pp.firebaseapp.com",
      projectId: "stok-gudang-divisi-pp",
      storageBucket: "stok-gudang-divisi-pp.firebasestorage.app",
      messagingSenderId: "838303987838",
      appId: "1:838303987838:web:e16829f449925469ae002f",
      measurementId: "G-QYH5LD18NT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ðŸ”¹ Tambah Produk
    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nama = document.getElementById("nama").value;
      const kategori = document.getElementById("kategori").value;
      const jumlah = parseInt(document.getElementById("jumlah").value);
      const penginput = document.getElementById("penginput").value;

      const productRef = doc(db, "produk", nama);
      const docSnap = await getDoc(productRef);

      if (docSnap.exists()) {
        await updateDoc(productRef, { jumlah: increment(jumlah) });
      } else {
        await setDoc(productRef, { nama, kategori, jumlah });
      }

      await addDoc(collection(db, "riwayat"), {
        nama,
        kategori,
        jumlah,
        penginput,
        waktu: new Date()
      });

      e.target.reset();
    });

    // ðŸ”¹ Realtime Daftar Produk
    const productList = document.getElementById("productList");
    const searchInput = document.getElementById("searchProduk");
    const filterKategori = document.getElementById("filterKategori");

    const qProduk = query(collection(db, "produk"), orderBy("nama"));
    onSnapshot(qProduk, (snapshot) => {
      let allProducts = [];
      snapshot.forEach((doc) => allProducts.push(doc.data()));

      function renderProducts() {
        const keyword = searchInput.value.toLowerCase();
        const kategoriFilter = filterKategori.value.toLowerCase();

        const filtered = allProducts.filter(p =>
          p.nama.toLowerCase().includes(keyword) &&
          (kategoriFilter === "" || p.kategori.toLowerCase().includes(kategoriFilter))
        );

        productList.innerHTML = "";
        filtered.forEach((p) => {
          const div = document.createElement("div");
          div.className = "bg-gray-700 p-2 rounded flex justify-between";
          div.innerHTML = `
            <span>${p.nama} (${p.kategori})</span>
            <span class="font-bold">${p.jumlah}</span>
          `;
          productList.appendChild(div);
        });
      }

      renderProducts();
      searchInput.addEventListener("input", renderProducts);
      filterKategori.addEventListener("input", renderProducts);
    });

    // ðŸ”¹ Realtime Riwayat
    const historyList = document.getElementById("historyList");
    const qRiwayat = query(collection(db, "riwayat"), orderBy("waktu", "desc"));
    onSnapshot(qRiwayat, (snapshot) => {
      historyList.innerHTML = "";
      snapshot.forEach((doc) => {
        const r = doc.data();
        const div = document.createElement("div");
        div.className = "bg-gray-700 p-2 rounded";
        div.innerHTML = `
          <p><b>${r.nama}</b> (${r.kategori}) ditambah <b>${r.jumlah}</b> oleh <i>${r.penginput}</i></p>
          <small>${r.waktu.toDate().toLocaleString()}</small>
        `;
        historyList.appendChild(div);
      });
    });
  </script>
</body>
</html>
